{% extends 'journal/base_dashboard.html' %}

{% block title %}Error Insights - Ray's Trading Journal{% endblock %}
{% block page_title %}Error Pattern Detection & Suggestions{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}"><i class="bi bi-speedometer2"></i> Insight Hub</a></li>
        <li class="breadcrumb-item active">Error Insights</li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    .insights-header-modern {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }
    
    [data-bs-theme="dark"] .insights-header-modern {
        background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
    }
    
    .intro-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
        border-left: 5px solid #3b82f6;
    }
    
    [data-bs-theme="dark"] .intro-card {
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .chart-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    [data-bs-theme="dark"] .chart-card {
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .chart-card .card-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
        border: none;
        padding: 1.25rem 1.5rem;
        font-weight: 600;
    }
    
    [data-bs-theme="dark"] .chart-card .card-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
    }
    
    .insight-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 5px solid;
        height: 100%;
    }
    
    [data-bs-theme="dark"] .insight-card {
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .insight-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
    }
    
    .severity-critical {
        border-left-color: #dc3545;
    }
    
    .severity-moderate {
        border-left-color: #ffc107;
    }
    
    .severity-improving {
        border-left-color: #28a745;
    }
    
    .insight-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-bottom: 2px solid #e9ecef;
        padding: 1.25rem 1.5rem;
    }
    
    [data-bs-theme="dark"] .insight-card .card-header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d3338 100%);
        border-bottom-color: #374151;
    }
    
    .stat-badge {
        font-size: 1.1rem;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        display: inline-block;
    }
    
    .suggestion-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-left: 4px solid #3b82f6;
        padding: 1.25rem;
        border-radius: 10px;
        margin-top: 1rem;
    }
    
    [data-bs-theme="dark"] .suggestion-box {
        background: linear-gradient(135deg, #2d3338 0%, #1a1a1a 100%);
        border-left-color: #60a5fa;
    }
    
    .btn-regenerate {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        border: none;
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }
    
    .btn-regenerate:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="insights-header-modern">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <h2 class="mb-2 fw-bold">
                <i class="bi bi-graph-down-arrow me-2"></i>Error Pattern Analysis
            </h2>
            <p class="mb-0 opacity-90">Automatically detect recurring mistakes and get actionable improvement suggestions</p>
        </div>
        <a href="{% url 'dashboard' %}" class="btn btn-light btn-sm">
            <i class="bi bi-arrow-left"></i> Dashboard
        </a>
    </div>
</div>

<!-- Introduction -->
<div class="intro-card card mb-4">
    <div class="card-body p-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div>
                <h5 class="mb-3 fw-bold">
                    <i class="bi bi-info-circle-fill text-primary me-2"></i>About Error Insights
                </h5>
                <p class="text-muted mb-3">
                    This section automatically analyzes your past trades to highlight recurring mistakes and provide 
                    actionable suggestions for improvement. The insights are generated from your After Trade, Pre Trade, 
                    and Backtesting journal entries.
                </p>
                <div class="d-flex flex-wrap gap-2">
                    <span class="stat-badge bg-primary text-white">
                        <i class="bi bi-bar-chart me-1"></i>Total Analyzed: {{ total_analyzed }}
                    </span>
                    {% if generated_at %}
                        <span class="stat-badge bg-secondary text-white">
                            <i class="bi bi-clock me-1"></i>Updated: {{ generated_at|date:"M d, Y H:i" }}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex flex-column gap-2">
                <div class="btn-group">
                    <a href="{% url 'error_insights' %}" class="btn btn-outline-light {% if not time_filter %}active{% endif %}">
                        All Time
                    </a>
                    <a href="{% url 'error_insights' %}?filter=last_30" class="btn btn-outline-light {% if time_filter == 'last_30' %}active{% endif %}">
                        Last 30 Trades
                    </a>
                </div>
                <form method="post" action="{% url 'regenerate_insights' %}{% if time_filter %}?filter={{ time_filter }}{% endif %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-regenerate text-white w-100">
                        <i class="bi bi-arrow-clockwise me-2"></i>Regenerate Insights
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Chart -->
{% if chart_data.labels %}
<div class="chart-card card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Error Pattern Distribution</h5>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 300px;">
            <canvas id="patternChart"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- Error Pattern Cards -->
{% if insights %}
    <div class="row g-4 mb-4">
        {% for insight in insights %}
            <div class="col-md-6">
                <div class="card insight-card 
                    {% if insight.severity_score >= 70 %}severity-critical
                    {% elif insight.severity_score >= 40 %}severity-moderate
                    {% else %}severity-improving{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            {% if insight.type == 'market_condition' %}
                                <i class="bi bi-cloud-rain-fill text-primary me-2"></i>
                            {% elif insight.type == 'discipline' %}
                                <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                            {% elif insight.type == 'bias' %}
                                <i class="bi bi-arrow-left-right text-info me-2"></i>
                            {% elif insight.type == 'entry_timing' %}
                                <i class="bi bi-clock-history text-danger me-2"></i>
                            {% elif insight.type == 'poi' %}
                                <i class="bi bi-bullseye text-secondary me-2"></i>
                            {% elif insight.type == 'session' %}
                                <i class="bi bi-calendar-event-fill text-success me-2"></i>
                            {% elif insight.type == 'behavior' %}
                                <i class="bi bi-graph-down text-danger me-2"></i>
                            {% else %}
                                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                            {% endif %}
                            {{ insight.title }}
                        </h5>
                        <span class="badge 
                            {% if insight.severity_score >= 70 %}bg-danger
                            {% elif insight.severity_score >= 40 %}bg-warning
                            {% else %}bg-success{% endif %} px-3 py-2">
                            {{ insight.severity_score }}%
                        </span>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">{{ insight.description }}</p>
                        
                        <div class="mb-3">
                            <strong><i class="bi bi-bar-chart-fill me-2"></i>Statistics:</strong>
                            <div class="stat-badge bg-light text-dark mt-2">
                                {{ insight.statistics }}
                            </div>
                        </div>
                        
                        <div class="suggestion-box">
                            <strong><i class="bi bi-lightbulb-fill text-warning me-2"></i>Suggestion:</strong>
                            <p class="mb-0 mt-2">{{ insight.suggestion }}</p>
                        </div>
                        
                        {% if insight.filter_params %}
                            <div class="mt-3">
                                <form method="get" action="{% url 'view_related_trades' %}" class="d-inline">
                                    {% for key, value in insight.filter_params.items %}
                                        {% if value|length > 1 %}
                                            {% for v in value %}
                                                <input type="hidden" name="{{ key }}" value="{{ v }}">
                                            {% endfor %}
                                        {% else %}
                                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                                        {% endif %}
                                    {% endfor %}
                                    <button type="submit" class="btn btn-outline-primary">
                                        <i class="bi bi-list-ul me-2"></i>View Related Trades
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #6c757d;"></i>
            <h5 class="mt-3 text-muted">No Error Patterns Detected</h5>
            <p class="text-muted">
                {% if total_analyzed == 0 %}
                    Start creating journal entries to generate insights. You need at least 3 trades to detect patterns.
                {% else %}
                    Great job! No significant error patterns detected in your recent trading. Keep maintaining good discipline!
                {% endif %}
            </p>
            {% if total_analyzed == 0 %}
                <a href="{% url 'after_trade_create' %}" class="btn btn-primary mt-2">
                    <i class="bi bi-plus-circle me-2"></i>Create Your First Trade Entry
                </a>
            {% endif %}
        </div>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if chart_data.labels %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('patternChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ chart_data.labels|safe }},
                datasets: [{
                    label: 'Pattern Count',
                    data: {{ chart_data.counts }},
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(251, 191, 36, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(139, 92, 246, 1)',
                        'rgba(236, 72, 153, 1)',
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
</script>
{% endif %}
{% endblock %}
