{% extends 'journal/base_dashboard.html' %}
{% block title %}Lot Size Calculator - Ray's JournalX{% endblock %}
{% block page_title %}Lot Size Calculator{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}"><i class="bi bi-speedometer2"></i> Insight Hub</a></li>
        <li class="breadcrumb-item active">Lot Size Calculator</li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    .calculator-header-modern {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }
    
    [data-bs-theme="dark"] .calculator-header-modern {
        background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
    }
    
    .calculator-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.15);
        overflow: hidden;
    }
    
    [data-bs-theme="dark"] .calculator-card {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .calculator-card .card-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
        border: none;
        padding: 1.5rem;
        font-weight: 600;
    }
    
    [data-bs-theme="dark"] .calculator-card .card-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
    }
    
    .result-card {
        border: none;
        border-radius: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-left: 5px solid #3b82f6;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    
    [data-bs-theme="dark"] .result-card {
        background: linear-gradient(135deg, #2d3338 0%, #1a1a1a 100%);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15);
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn-calculate {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        border: none;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }
    
    .btn-calculate:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4);
    }
    
    .lot-size-display {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    [data-bs-theme="dark"] .lot-size-display {
        background: linear-gradient(135deg, #60a5fa, #93c5fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* Searchable dropdown styles */
    .instrument-search-wrapper {
        position: relative;
    }
    
    .instrument-search-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
    }
    
    .instrument-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: none;
    }
    
    [data-bs-theme="dark"] .instrument-dropdown {
        background: #2d3338;
        border-color: #4b5563;
    }
    
    .instrument-option {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s;
    }
    
    [data-bs-theme="dark"] .instrument-option {
        border-bottom-color: #4b5563;
    }
    
    .instrument-option:hover {
        background-color: #f8f9fa;
    }
    
    [data-bs-theme="dark"] .instrument-option:hover {
        background-color: #374151;
    }
    
    .instrument-option.selected {
        background-color: #3b82f6;
        color: white;
    }
    
    .instrument-option .instrument-name {
        font-weight: 600;
    }
    
    .instrument-option .instrument-type {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-left: 0.5rem;
    }
    
    .real-time-result {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
        display: none;
    }
    
    [data-bs-theme="dark"] .real-time-result {
        background: #2d3338;
    }
</style>
{% endblock %}

{% block content %}
<div class="calculator-header-modern">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <h2 class="mb-2 fw-bold">
                <i class="bi bi-calculator-fill me-2"></i>Lot Size Calculator
            </h2>
            <p class="mb-0 opacity-90">Calculate the optimal lot size for your trades based on risk management</p>
        </div>
        <a href="{% url 'dashboard' %}" class="btn btn-light btn-sm">
            <i class="bi bi-arrow-left"></i> Dashboard
        </a>
    </div>
</div>

<div class="calculator-card card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Input Parameters</h5>
    </div>
    <div class="card-body p-4">
        <form method="post" id="lotCalculatorForm">
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Account Balance *</label>
                    {{ form.account_balance }}
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Currency *</label>
                    {{ form.account_currency }}
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Risk Percentage *</label>
                    {{ form.risk_percentage }}
                    <small class="form-text text-muted d-block mt-1"><i class="bi bi-info-circle"></i> Percentage of account to risk</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Stop Loss (Pips/Points) *</label>
                    {{ form.stop_loss_pips }}
                    <small class="form-text text-muted d-block mt-1"><i class="bi bi-info-circle"></i> Stop loss distance in pips/points</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Instrument *</label>
                    <select name="instrument" id="instrument_select" class="form-select" required>
                        <option value="">Search or select instrument...</option>
                        {% for code, name in form.fields.instrument.choices %}
                            {% if code %}
                                <option value="{{ code }}">{{ name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted d-block mt-1">
                        <i class="bi bi-info-circle"></i> 
                        <span id="pip_value_display">Type to search instruments</span>
                    </small>
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-calculate text-white w-100 w-md-auto">
                        <i class="bi bi-calculator-fill me-2"></i>Calculate Lot Size
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Real-time calculation result -->
        <div id="real_time_result" class="real-time-result">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Estimated Lot Size:</strong>
                    <span id="real_time_lot_size" class="lot-size-display" style="font-size: 1.5rem; margin-left: 0.5rem;">-</span>
                </div>
                <small class="text-muted">Updates as you type</small>
            </div>
        </div>
    </div>
</div>

<!-- Recent Calculations History -->
{% if recent_calculations %}
<div class="calculator-card card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Calculations</h5>
    </div>
    <div class="card-body p-4">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Instrument</th>
                        <th>Balance</th>
                        <th>Risk %</th>
                        <th>Stop Loss</th>
                        <th>Lot Size</th>
                    </tr>
                </thead>
                <tbody>
                    {% for calc in recent_calculations %}
                    <tr>
                        <td>{{ calc.created_at|date:"M d, Y H:i" }}</td>
                        <td><strong>{{ calc.instrument }}</strong></td>
                        <td>{{ calc.account_balance }} {{ calc.account_currency }}</td>
                        <td>{{ calc.risk_percentage }}%</td>
                        <td>{{ calc.stop_loss_pips }} pips</td>
                        <td><strong class="text-primary">{{ calc.calculated_lot_size }} lots</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
        
{% if result %}
<div class="result-card card">
    <div class="card-body p-4">
        <div class="text-center mb-3">
            <h5 class="text-muted mb-3"><i class="bi bi-check-circle-fill text-primary me-2"></i>Calculated Result</h5>
            <div class="lot-size-display mb-3">{{ result }} lots</div>
            <p class="text-muted mb-0">
                Recommended lot size
                {% if instrument_data %}
                    <br><small>Pip/Point Value: ${{ instrument_data.pip_value }} per standard lot</small>
                {% endif %}
            </p>
        </div>
        <div class="d-flex justify-content-center gap-2 mt-4">
            <button class="btn btn-primary btn-lg" onclick="navigator.clipboard.writeText('{{ result }}'); this.innerHTML='<i class=\'bi bi-check-circle me-2\'></i>Copied!'; setTimeout(() => this.innerHTML='<i class=\'bi bi-clipboard me-2\'></i>Copy to Clipboard', 2000);">
                <i class="bi bi-clipboard me-2"></i>Copy to Clipboard
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Instrument data from backend
    const instruments = JSON.parse('{{ instruments_json|escapejs }}');
    
    // Searchable dropdown functionality
    document.addEventListener('DOMContentLoaded', function() {
        const instrumentSelect = document.getElementById('instrument_select');
        const pipValueDisplay = document.getElementById('pip_value_display');
        const realTimeResult = document.getElementById('real_time_result');
        const realTimeLotSize = document.getElementById('real_time_lot_size');
        
        // Create searchable dropdown
        const originalSelect = instrumentSelect.cloneNode(true);
        const searchWrapper = document.createElement('div');
        searchWrapper.className = 'instrument-search-wrapper';
        
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control instrument-search-input';
        searchInput.placeholder = 'Type to search instruments (e.g., EURUSD, Gold, NAS100)...';
        searchInput.autocomplete = 'off';
        
        const dropdown = document.createElement('div');
        dropdown.className = 'instrument-dropdown';
        dropdown.id = 'instrument_dropdown';
        dropdown.style.display = 'none'; // Hide by default
        
        // Replace select with searchable input
        instrumentSelect.parentNode.insertBefore(searchWrapper, instrumentSelect);
        searchWrapper.appendChild(searchInput);
        searchWrapper.appendChild(dropdown);
        instrumentSelect.style.display = 'none';
        
        // Populate dropdown with all options
        function populateDropdown(filter = '') {
            dropdown.innerHTML = '';
            const filterUpper = filter.toUpperCase();
            let hasResults = false;
            
            Array.from(originalSelect.options).forEach(option => {
                if (option.value && (filter === '' || 
                    option.value.toUpperCase().includes(filterUpper) || 
                    option.text.toUpperCase().includes(filterUpper))) {
                    const div = document.createElement('div');
                    div.className = 'instrument-option';
                    div.dataset.value = option.value;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'instrument-name';
                    nameSpan.textContent = option.text;
                    
                    const typeSpan = document.createElement('span');
                    typeSpan.className = 'instrument-type';
                    const instrumentData = instruments[option.value];
                    if (instrumentData) {
                        typeSpan.textContent = `(${instrumentData.type})`;
                    }
                    
                    div.appendChild(nameSpan);
                    div.appendChild(typeSpan);
                    
                    div.addEventListener('click', function() {
                        selectInstrument(option.value, option.text);
                    });
                    
                    dropdown.appendChild(div);
                    hasResults = true;
                }
            });
            
            return hasResults;
        }
        
        // Show dropdown with filtered results
        function showDropdown(filter = '') {
            const hasResults = populateDropdown(filter);
            if (hasResults) {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        function selectInstrument(value, text) {
            instrumentSelect.value = value;
            searchInput.value = text;
            dropdown.style.display = 'none';
            
            // Update pip value display
            const instrumentData = instruments[value];
            if (instrumentData) {
                pipValueDisplay.innerHTML = `<strong>Pip/Point Value:</strong> $${instrumentData.pip_value} per standard lot`;
            } else {
                pipValueDisplay.textContent = 'Type to search instruments';
            }
            
            // Trigger real-time calculation
            calculateRealTime();
        }
        
        // Show dropdown when input is focused or clicked
        searchInput.addEventListener('focus', function() {
            showDropdown(this.value);
        });
        
        searchInput.addEventListener('click', function() {
            showDropdown(this.value);
        });
        
        // Search input event
        searchInput.addEventListener('input', function(e) {
            const filter = e.target.value;
            showDropdown(filter);
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchWrapper.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Real-time calculation
        function calculateRealTime() {
            const accountBalance = parseFloat(document.getElementById('account_balance')?.value || 0);
            const riskPercentage = parseFloat(document.getElementById('risk_percentage')?.value || 0);
            const stopLossPips = parseFloat(document.getElementById('stop_loss_pips')?.value || 0);
            const instrumentCode = instrumentSelect.value;
            
            if (accountBalance > 0 && riskPercentage > 0 && stopLossPips > 0 && instrumentCode) {
                const instrumentData = instruments[instrumentCode];
                if (instrumentData) {
                    const riskAmount = accountBalance * (riskPercentage / 100);
                    const pipValue = instrumentData.pip_value;
                    const lotSize = riskAmount / (stopLossPips * pipValue);
                    
                    if (lotSize > 0 && isFinite(lotSize)) {
                        realTimeLotSize.textContent = lotSize.toFixed(2) + ' lots';
                        realTimeResult.style.display = 'block';
                    } else {
                        realTimeResult.style.display = 'none';
                    }
                } else {
                    realTimeResult.style.display = 'none';
                }
            } else {
                realTimeResult.style.display = 'none';
            }
        }
        
        // Add event listeners for real-time calculation
        ['account_balance', 'risk_percentage', 'stop_loss_pips'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', calculateRealTime);
                input.addEventListener('change', calculateRealTime);
            }
        });
        
        instrumentSelect.addEventListener('change', function() {
            const selectedOption = originalSelect.querySelector(`option[value="${this.value}"]`);
            if (selectedOption) {
                searchInput.value = selectedOption.text;
                selectInstrument(this.value, selectedOption.text);
            }
        });
        
        // Initialize: don't show dropdown on page load, only when user interacts
        // Dropdown is already hidden by default
    });
</script>
{% endblock %}
